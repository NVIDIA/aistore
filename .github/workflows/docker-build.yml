name: Build and Push Docker Image

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
        description: 'Image repository (e.g. aistorage/aisnode)'
      image_tag:
        required: true
        type: string
        description: 'Image tag (e.g. latest, v1.0)'
      context_dir:
        required: true
        type: string
        description: 'Directory containing Makefile and Dockerfile'
      commit_sha:
        required: false
        type: string
        default: ''
        description: 'Commit SHA for image labeling'
      build_tags:
        required: false
        type: string
        default: ''
        description: 'Go build tags (e.g. oteltracing)'
      extra_env:
        required: false
        type: string
        default: ''
        description: 'Additional env vars for make (space-separated KEY=VALUE pairs)'
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        working-directory: ${{ inputs.context_dir }}
        run: |
          IMAGE_REPO="${{ inputs.image_name }}" \
          IMAGE_TAG="${{ inputs.image_tag }}" \
          COMMIT_SHA="${{ inputs.commit_sha }}" \
          BUILD_TAGS="${{ inputs.build_tags }}" \
          ${{ inputs.extra_env }} \
          make -e all
