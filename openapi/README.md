---
layout: post
title: OPENAPI
permalink: openapi
redirect_from:
 - openapi/README.md/
---

## Python Client Package

## Table of Contents

- [Overview](#overview)
- [How to generate package](#how-to-generate-package)
- [How to run tests](#how-to-run-tests)
- [How to install](#how-to-install)
- [How to use package](#how-to-use-package)
    - [Overview](#overview-1)
    - [Creating Api Clients](#creating-api-clients)
    - [Performing Operations](#performing-operations)
        - [Bucket](#bucket)
        - [Cluster](#cluster)
        - [Daemon](#daemon)
        - [Object](#object)
        - [Sort](#sort)
        - [Querying](#querying)
- [Future](#future)

## Overview

OpenAPI Generator (formerly called Swagger) is used to generate a python client package for simplified integration with the RESTful API.

Note that, as of v2.0, [python3 is currently not fully supported](#future).

A description of the package and how to use it can be found [here](#how-to-use).

The file [openapi.yaml](openapi.yaml) specifies the API endpoints that the package provides and should remain up to date with any changes to them in AIS.

The documentation for OpenAPI Generator itself can be found [here](https://github.com/openapitools/openapi-generator).

## How to generate package

The python client package is generated by [openapitools/openapi-generator](https://github.com/openapitools/openapi-generator), and will be placed in `<path_to_repo>/python/api-client`.

As of v2.0, the repository does not store the generated package, and therefore you must follow the following steps to generate the package before running any [tests](#how-to-run-tests) or [installing](#how-to-install-client-package) it.

Should you have any difficulty with these instructions, please open a ticket, and we will provide assistance.

1. Obtain the latest, as of v2.0, openapi-generator jar by running the following command:

```console
$ wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/4.2.3/openapi-generator-cli-4.2.3.jar -O openapi-generator-cli.jar
```

2. Run the following commands:

```console
$ cd </path/to/aistore>
$ java -jar </path/to/openapi-generator-cli.jar> generate -i openapi/openapi.yaml -c openapi/config.json -g python -o ./python/api-client/
```

3. Install `pip` - a package management system used to install and manage software packages written in Python. Visit the [installation page](https://pip.pypa.io/en/stable/installing/) for instructions on how to install `pip`.

4. Install required Python packages using `pip` and requirement files located in `python/api-client` directory:

```console
$ pip install -r python/api-client/requirements.txt
$ pip install -r python/api-client/test-requirements.txt
```

If you don't wish to install these packages system wide for a particular user, consider using a [virtual environment](https://pypi.org/project/virtualenv/).

Afterwards, if for any reason you want to remove the generated package, you can do the following:

```console
# remember to commit any manually edited files first
$ cd <path_to_repo>
$ git clean -fd -- python/api-client
$ git checkout HEAD -- python/api-client
```

## How to run tests

First, ensure that you have followed [the instructions for generating the package](#how-to-generate-package).

Next, ensure that your machine has a [local testing deployment of AIS](/README.md#local-non-containerized).

Note that you do not need to install the package to run tests.

Run tests by running the following command:

```console
$ cd <path_to_repo>
$ BUCKET=<bucket_name> python -m unittest discover python/api-client/
```

## How to install

First, ensure that you have followed [the instructions for generating the package](#how-to-generate-package).

Then install the package by doing:

```console
$ cd <path_to_repo>/python/api-client
$ pip uninstall ais_client #uninstalls any previous versions
$ pip install .
```

## How to use package

### Overview

This package works by creating python objects (called 'api client' in this document) representing a target or proxy.

It is designed to provide a python interface of the same functionality as the [RESTful API](/docs/http_api.md)

Operations on the client instance can be performed by using it to create another python object (called 'api instance' in this document).

### Creating Api Clients

First, ensure that you have followed [the instructions for installing the package](#how-to-install)

1. In your python script or interpreter, import the python client package.

```python
import ais_client

# Some aliases for functions in the package, will use later in document as shorthand
openapi_models = ais_client.models
openapi_params = openapi_models.InputParameters
openapi_actions = openapi_models.Actions
```

2. For each proxy or target url that you want to communicate with, create an api client.

```python
# Initialize the configuration object
configuration = ais_client.Configuration()
configuration.debug = False

# Example first api client
proxy_url = 'localhost:8080' #Change this to your your proxy's ip, ex: 172.50.0.2:8080
configuration.host = 'http://%s/v1/' % proxy_url
proxyClient = ais_client.ApiClient(configuration)

# Example second api client
target_url = 'localhost:8089' #Change this to your your target's ip, ex: 172.50.0.2:8083
configuration.host = 'http://%s/v1/' % target_url
targetClient = ais_client.ApiClient(configuration)
```

### Performing Operations

Create api instances for each api client that you want to perform operations on.

Each different api instance can perform a particular group of operations.

This means that, for each api client, you will have to create multiple api instances if you want to run operations from multiple groups.

The following sections list instructions for creating api instance and how to use it to perform operations, partitioned by group.

The return type for each operation is also listed. Some of them are objects specific to the package. Documentation for said objects are generated along with the package, and can be viewed to obtain a list of their properties.

| Object Name | Document Location |
| --- | --- |
| ObjectPropertyList | `</path/to/package>/docs/ObjectPropertyList.md` |
| BucketNames | `</path/to/package>/docs/BucketNames.md` |

Note that operations may raise `ais_client.rest.ApiException` as part of normal operations. The `status` property of the ApiException can hold some useful information.

#### Bucket

First, create an api instance `bucket_api = ais_client.api.bucket_api.BucketApi(proxyClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- |
| Get bucket names | `bucket_api.list_names()` <sup>[1](#ftb1)</sup>  | BucketNames |
| List objects in bucket | `bucket_api.perform_operation('myS3bucket', openapi_params(openapi_actions.LISTOBJECTS, value=openapi_models.ObjectPropertiesRequestParams(props="size")))` <sup>[2](#ftb2)</sup> | ObjectPropertyList|
| Create ais bucket (proxy) | `bucket_api.perform_operation('mybucket', openapi_params(openapi_actions.CREATELB))` | ObjectPropertyList |
| Destroy ais bucket (proxy) | `bucket_api.delete('mybucket', openapi_params(openapi_actions.DESTROYLB))` | None |
| Rename ais bucket (proxy) | `bucket_api.perform_operation('oldname', openapi_params(openapi_actions.RENAMELB, name='newname'))` | ObjectPropertyList |
| [Evict](/docs/bucket.md#evict-bucket) cloud bucket (proxy) | `bucket_api.delete('myS3bucket', openapi_params(openapi_actions.EVICTCB))` | None |
| Set bucket props (proxy) | `bucket_api.set_properties('mybucket', openapi_params(openapi_actions.SETPROPS, value=openapi_models.BucketProps(provider="ais", checksum=openapi_models.BucketPropsCksum(checksum="inherit"))))` | None |
| [Prefetch](/docs/bucket.md#prefetchevict-objects) a list of objects | `bucket_api.perform_operation('mybucket', openapi_params(openapi_actions.PREFETCH, value=openapi_models.ListParameters(objnames=["o1","o2","o3"])))` <sup>[3](#ftb3)</sup> | ObjectPropertyList |
| [Prefetch](/docs/bucket.md#prefetchevict-objects) a range of objects | `bucket_api.perform_operation('mybucket', openapi_params(openapi_actions.PREFETCH, value=openapi_models.RangeParameters(template="__tst/test-{1000..2000}")))` <sup>[3](#ftb3)</sup> | None |
| Delete a list of objects | `bucket_api.delete('mybucket', openapi_params(openapi_actions.DELETE, value=openapi_models.ListParameters(objnames=["o1","o2","o3"])))` <sup>[3](#ftb3)</sup> | None |
| Delete a range of objects | `bucket_api.delete('mybucket', openapi_params(openapi_actions.DELETE, value=openapi_models.RangeParameters(prefix="__tst/test-{1000.2000}")))` <sup>[3](#ftb3)</sup> | None |
| [Evict](/docs/bucket.md#prefetchevict-objects) a list of objects | `bucket_api.delete('mybucket', openapi_params(openapi_actions.EVICTOBJECTS, value=openapi_models.ListParameters(objnames=["o1","o2","o3"])))` <sup>[3](#ftb3)</sup> | None |
| [Evict](/docs/bucket.md#prefetchevict-objects) a range of objects | `bucket_api.delete('mybucket', openapi_params(openapi_actions.EVICTOBJECTS, value=openapi_models.RangeParameters(prefix="__tst/test-{1000..2000}")))` <sup>[3](#ftb3)</sup> | None |
| Get bucket props (proxy) | `bucket_api.get_properties_with_http_info('mybucket')[2]` | dict |

<a name="ftb1">1</a>: Optional parameter `loc=true` can be used to retrieve just the ais buckets, this causes the `cloud` property to be the empty array

<a name="ftb2">2</a>: See the [List Objects section](/docs/bucket.md#list-objects) for details.

<a name="ftb3">3</a>: See the [List/Range Operations section](/docs/batch.md#listrange-operations) for details.

#### Cluster

First, create an api instance `cluster_api = ais_client.api.cluster_api.ClusterApi(proxyClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- |
| Unregister storage target | cluster_api.unregister_target("15205:8083") | None |
| Register storage target | `mNetInfo = openapi_models.NetInfo(node_ip_addr="172.16.175.41", daemon_port="8083", direct_url="http://172.16.175.41:8083")`<br>`cluster_api.register_target(openapi_models.Snode(daemon_id="43888:8083", public_net=mNetInfo, intra_control_net=mNetInfo, intra_data_net=mNetInfo))` | None |
| Set primary proxy forcefully(primary proxy) | `cluster_api.set_primary_proxy("43888:8083")` | dict |
| Set cluster-wide configuration (proxy) | `cluster_api.perform_operation(openapi_params(openapi_actions.SETCONFIG, name="stats_time", value="1s"))` <br> please see [runtime configuration](/docs/configuration.md#runtime-configuration) for the option list | None |
| Shutdown cluster (proxy)| `cluster_api.perform_operation(openapi_params(openapi_actions.SHUTDOWN))` | None |
| Rebalance cluster (proxy)| `cluster_api.perform_operation(openapi_params(openapi_actions.REBALANCE))` | None |

#### Daemon

First, create an api instance `daemon_api = ais_client.api.daemon_api.DaemonApi(targetClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- |
| Update individual AIStore daemon (proxy or target) configuration | `daemon_api.perform_operation(openapi_params(openapi_actions.SETCONFIG, name="stats_time", value="1s"))` <br> please see [runtime configuration](/docs/configuration.md#runtime-configuration) for the option list | None |
| Shutdown cluster (proxy)| `daemon_api.perform_operation(openapi_params(openapi_actions.SHUTDOWN))` | None |
| Disable mountpath in target | `daemon_api.modify_mountpath(openapi_params(openapi_actions.DISABLE, value="/mount/path"))` | None <sup>[1](#ftd1)</sup>  |
| Enable mountpath in target | `daemon_api.modify_mountpath(openapi_params(openapi_actions.ENABLE, value="/mount/path"))` | None <sup>[1](#ftd1)</sup> |
| Remove mountpath from target | `daemon_api.remove_mountpath(openapi_params(openapi_actions.REMOVE, value="/mount/path"))` | None |
| Add mountpath in target | `daemon_api.create_mountpath(openapi_params(openapi_actions.ADD, value="/mount/path"))` | None |

<a name="ftd1">1</a>: raises ApiException with `status` of `204` if the mountpath is already enabled/disabled or `404` if mountpath was not found.

#### Object

First, create an api instance `object_api = ais_client.api.object_api.ObjectApi(proxyClient)`.

| Operation | Code Example | Return Type |
| --- | --- | --- |
| Get object (proxy) | `object_api.get('myS3bucket', 'myobject')` | str |
| Read range (proxy) | `object_api.get('myS3bucket', 'myobject', offset=1024, length=512)` | str |
| Put object (proxy) | `object_api.put('myS3bucket', 'myobject', body='object content here')` | None |
| Rename/move object (ais buckets) | `object_api.perform_operation('mylocalbucket', 'dir1/CCCCCCC', input_parameters=openapi_params(openapi_actions.RENAME, 'dir2/DDDDDDD'))` | None |
| Delete object | `object_api.delete('mybucket', 'myobject')` | None |
| Evict object from cache | `object_api.delete('mybucket', 'myobject', input_parameters=openapi_params(openapi_actions.EVICTOBJECTS))` | None |
| Get object props | `object_api.get_properties_with_http_info('mybucket', 'myobject')[2]` | dict |
| Check if an object is cached | `object_api.get_properties_with_http_info('mybucket', 'myobject', check_cached=True)` | tuple (raises ApiException if answer is no) |

Note that the `Copy object` operation (`object_api.put` with the kwargs `from_id`/`to_id` instead of `body`), as of v2.0, doesn't work yet.

#### Sort

First, create an api instance `sort_api = ais_client.api.sort_api.SortApi(proxyClient)`.

See the files mentioned [here](/dsort/playground/README.md#python) for examples of how to use `sort_api`.

#### Querying

AIStore provides an extensive list of operations to retrieve cluster current state.

Note that these are called on the api instances [cluster_api](#cluster) and [daemon_api](#daemon).

| Operation | Code Example | Return Type |
| --- | --- | --- |
| Get cluster map | `daemon_api.get(openapi_models.GetWhat.SMAP)` | dict |
| Get proxy or target configuration | `daemon_api.get(openapi_models.GetWhat.CONFIG)` | dict |
| Get proxy/target info	 | `daemon_api.get(openapi_models.GetWhat.DAEMONINFO`) | dict |
| Get cluster statistics (proxy) | `cluster_api.get(openapi_models.GetWhat.STATS)` | dict |
| Get target statistics | `daemon_api.get(openapi_models.GetWhat.STATS)` | dict |
| Get process info for all nodes in cluster (proxy) | `cluster_api.get(openapi_models.GetWhat.SYSINFO)` | dict |
| Get proxy or target process info | `daemon_api.get(openapi_models.GetWhat.SYSINFO)` | dict |
| Get rebalance statistics (proxy) | `cluster_api.get(openapi_models.GetWhat.XACTION, props=openapi_models.GetProps.REBALANCE)` | dict |
| Get prefetch statistics (proxy) | `cluster_api.get(openapi_models.GetWhat.XACTION, props=openapi_models.GetProps.PREFETCH)` | dict |
| Get list of target's filesystems (target) | `daemon_api.get(openapi_models.GetWhat.MOUNTPATHS)` | dict |
| Get list of all targets' filesystems (proxy) | `cluster_api.get(openapi_models.GetWhat.MOUNTPATHS)` | dict |
| Get target bucket list | `daemon_api.get(openapi_models.GetWhat.BUCKETMD)` | dict |

## Future

The python client package, as of v2.0, is only fully supported in python 2.

This is because openapi-generator has a problem in python3 with fetching binary data in the form of octet-stream.

```
https://github.com/OpenAPITools/openapi-generator/issues/1445
https://github.com/OpenAPITools/openapi-generator/issues/206
```

For now, as of v2.0, it's recommended to only use python 2 with the package.
